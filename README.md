The codes in this repository are for the demonstration of our work [1].


**ORGANIZATION**

1.	example_data:
a.	healthy:
i.	cropped:  z-scan LS-GLIM images of a healthy embryo
ii.	new: folder for NPM model predictions
b.	sick:
i.	cropped:  z-scan LS-GLIM images of a sick embryo
ii.	new: folder for NPM model predictions
c.	sparse_prediction:
i.	overlapped: z-slice images (3-channel image with interslice distance 1 um) spaced 3 um apart for a live (H/I) embryo
2.	FBM: Feature based model prediction scripts and trained model
3.	IBM: Image based model prediction scripts and trained model
4.	NPM: Nucleus prediction model inference scripts and trained model
5.	MATLAB-APP: Standalone MATLAB application


**REQUIREMENTS**


1.	FBM, MATLAB- APP: MATLAB R2022b
2.	IBM: Python 3.9.7 and Pytorch 1.11.0, MATLAB R2022b
3.	NPM: listed in requirements.txt in embryo_ls_glim-main/NPM

**OPERATING INSTRUCTIONS**

Download and extract embryo_ls_glim-main.zip\embryo_ls_glim-main

**1.	NPM predictions**
Example data is here: embryo_ls_glim-main /example_data/healthy (or sick)/cropped
Inference script is here: embryo_ls_glim-main /NPM/scripts/infer.py
Provide your system path to the example data in line 35 of infer.py. To run inference on a Linux machine type command:
python infer.py
The results will be saved in embryo_ls_glim-main/NPM/sessions/trained_model/eval_final_model/infer_on_all
Copy the files in the infer_on_all folder to embryo_ls_glim-main /example_data/healthy (or sick)/new

**2.	IBM predictions:**
The input dataset for this script is in embryo_ls_glim-main /example_data/healthy (or sick, or sparse_prediction)/overlapped. This folder and the associated files are generated by the MATLAB app. Hence, MATLAB app needs to run before using this script.

Edit the following paths in the Jupyter notebook  embryo_ls_glim-main /IBM/ IBM_predict.ipynb
Cell 4, line 4: base_folder-your system path to extracted embryo_ls_glim-main
Cell 4, line 6: data folder-healthy, sick or sparse_prediction

To get embryo-level predictions, run MATLAB script embryo_ls_glim-main /IBM/ IBM_max_voting.m
Line 11: Provide system path to embryo_ls_glim-main /example_data/healthy (or sick, or sparse_prediction)/overlapped

Here, we are assuming that any unknown class embryo is by default sick, so the output file (result.csv) will read most predicted class as the final class assigned by IBM to the whole embryo (0:H/I, 1:S), probability is the average probability of z-slices being of S class, error_probability is the average probability of z-slices being of H/I class, percentage_mode_error is the percentage of z-slices predicted as H/I class and percentage_mode_total is the percentage of z-slices predicted as S class. 

MATLAB app can automatically run this max-voting and show the results graphically as explained in the Supplementary information of [1].

**3.	FBM predictions**
The input dataset is var3.csv generated by MATLAB app.  Hence, MATLAB app needs to run before using this script.
To get FBM predictions, run the MATLAB script embryo_ls_glim-main /FBM/ FBM_predict.m.
Change the following:
Line 14: Provide system path to embryo_ls_glim-main /FBM. 
Line 16: Provide system path to embryo_ls_glim-main /example_data/healthy (or sick)
The embryo level result will be saved as ‘result.csv’ in embryo_ls_glim-main /example_data/healthy (or sick) folder. The interpretations are same as IBM results.
MATLAB app can automatically run this prediction and max-voting and show the results graphically as explained in the Supplementary information of [1].

**MATLAB APPLICATION:**
The operating instructions are provided in the Supplementary information of [1]. Example data for panels Segment and Analyze are embryo_ls_glim-main /example_data/healthy (or sick). Example data for Analyze on few slices is embryo_ls_glim-main /example_data/sparse_prediction.
This app will only need NPM predictions and IBM z-slice predictions from outside the MATLAB environment and can do the rest of the processing itself.


**ACKNOWLEDGEMENTS/CREDIT**

The NPM model is a modified version (addition of further custom loss and metric) of Efficient-net Unet  segmentation model from https://gitlab.engr.illinois.edu/he44/phase_fl, which is further developed around the Efficient-net Unet segmentation models by https://github.com/qubvel/segmentation_models.


**SOURCE PUBLICATION**

[1]. Goswami, Neha, et al. "Machine learning assisted health viability assay for mouse embryos with artificial confocal microscopy (ACM)." bioRxiv (2023): 2023-07.
